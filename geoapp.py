# -*- coding: utf-8 -*-
"""geoapp.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/17vp2_VwrWiTXAsozZ6uoV9dY-DnHOGxw
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import requests
from scipy.spatial import ConvexHull
import numpy as np

# --------------------------------------------------
# Configura√ß√£o da p√°gina
# --------------------------------------------------
st.set_page_config(
    page_title="Mapa de Cidades por Regional",
    layout="wide"
)

st.title("üó∫Ô∏è Mapa de Cidades por Regional e Coordenador")

# --------------------------------------------------
# Cache de dados
# --------------------------------------------------
@st.cache_data
def load_geojson():
    url = "https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson"
    return requests.get(url).json()

@st.cache_data
def load_data():
    return pd.read_csv("geodata.csv")

geojson_br = load_geojson()
df_agg = load_data()

# --------------------------------------------------
# Scatter mapbox base
# --------------------------------------------------
fig = px.scatter_mapbox(
    df_agg,
    lat='latitude',
    lon='longitude',
    color='REGIONAL',
    size='QTD_LOJAS',
    hover_name='CIDADE',
    hover_data={
        'COORDENADOR': True,
        'QTD_LOJAS': True,
        'latitude': False,
        'longitude': False
    },
    height=600
)

# --------------------------------------------------
# Pol√≠gonos (√°reas dos coordenadores)
# --------------------------------------------------
for coord in df_agg['COORDENADOR'].unique():
    df_coord = df_agg[df_agg['COORDENADOR'] == coord]

    if len(df_coord) >= 3:
        points = df_coord[['longitude', 'latitude']].to_numpy()
        hull = ConvexHull(points)

        polygon_lon = points[hull.vertices, 0].tolist() + [points[hull.vertices, 0][0]]
        polygon_lat = points[hull.vertices, 1].tolist() + [points[hull.vertices, 1][0]]

        fig.add_trace(go.Scattermapbox(
            lon=polygon_lon,
            lat=polygon_lat,
            mode='lines',
            fill='toself',
            fillcolor='rgba(0,0,0,0.15)',
            line=dict(color='rgba(0,0,0,0)'),
            showlegend=False
        ))

# --------------------------------------------------
# Layout final
# --------------------------------------------------
fig.update_layout(
    mapbox_style="open-street-map",
    mapbox_center={"lat": -14.2350, "lon": -51.9253},
    mapbox_zoom=3.5,
    mapbox_layers=[{
        "source": geojson_br,
        "type": "line",
        "color": "black",
        "line": {"width": 1.5},
        "below": "traces"
    }],
    margin={"r": 0, "t": 40, "l": 0, "b": 0},
    title="Os pontos das cidades variam de cor conforme a regi√£o, e o tamanho aumenta quando a cidade "
    "possui mais de uma loja. As √°reas escuras representam regi√µes com a mesma coordena√ß√£o."
)

# --------------------------------------------------
# Renderizar no Streamlit
# --------------------------------------------------
st.plotly_chart(fig, use_container_width=True)
